
# Hello World Good-bye Unit - 設計思想書 (Design Philosophy) v2.6

> **Architect**: Grandmaster Game Designer  
> **Last Updated**: 2025-11-29  
> **Status**: Active / Production

---

## 📜 0. ドキュメントガバナンス

このドキュメントは、本プロジェクトにおける**「唯一の真実（Single Source of Truth）」**です。
コードの実装やバランス調整において迷いが生じた場合、常に本ドキュメントの記述を優先します。

### 関連ファイル
*   **データ設計・バランス**: [`ITEMS_DESIGN.md`](./ITEMS_DESIGN.md) - アイテムと数値バランスの詳細。
*   **開発者向け指針**: [`AGENTS.md`](./AGENTS.md) - AIエージェントおよび開発者の行動規範。
*   **セットアップ**: [`TAURI_SETUP.md`](./TAURI_SETUP.md), [`docs/PWA_SETUP.md`](./docs/PWA_SETUP.md) - 環境構築。

---

## 🏛 1. ゲームコンセプト

### 1.1 テーマ
**「高専生の試験期間サバイバル」**
理不尽な難易度、迫りくる締切、削れる精神、そして単位への渇望。これらをリソース管理シミュレーションとして表現します。

### 1.2 コア・フィロソフィー: "60点の壁"
本作の難易度設計における中心概念です。
*   **0-59点**: 努力で到達可能。チュートリアル区間。
*   **60点 (合格ライン)**: 大きな壁。これを超えるには「ただの勉強」では足りない。
    *   過去問（情報の非対称性）
    *   カフェイン（寿命の前借り）
    *   人脈（政治力）
    これらを駆使して初めて到達できる領域として設計します。
*   **90点 (S評価)**: 運と戦略が噛み合った時のみ到達可能な「神の領域」。

### 1.3 体験の柱 (Experience Pillars)
1.  **焦燥感の演出**: 常に減り続けるリソース、不穏なBGM、グリッチノイズ。
2.  **選択の重み**: 「睡眠をとるか、エナドリで徹夜するか」「プライドを捨てて教授に媚びるか」。全ての選択にトレードオフを持たせる。
3.  **失敗の物語化**: 留年（ゲームオーバー）もまた一つのエンディングであり、笑い話（ログ）として楽しめるようにする。

---

## ⚙️ 2. ゲームシステム設計

### 2.1 リソース管理 (The 4 Pillars)
| リソース | 役割 | ゲームオーバー条件 | 備考 |
| :--- | :--- | :--- | :--- |
| **HP (体力)** | 行動コストの源泉 | **0 = 入院 (敗北)** | 低下すると学習効率ダウン |
| **SAN (精神)** | ストレス耐性 | **0 = 発狂 (敗北)** | <30で「狂気モード」発動 |
| **SATIETY (満腹)** | 行動キャパシティ | なし | 高すぎると効率低下 (Food Coma) |
| **CAFFEINE** | 効率ブースト剤 | なし (200上限) | 依存症・中毒デバフのリスクあり |

### 2.2 時間システム (Time Slots)
1日を7つのスロットに分割し、それぞれに「意味」を持たせます。
*   `MORNING` / `AM`: **学習ゴールデンタイム** (効率高)
*   `NOON`: **魔の時間** (眠気・満腹デバフ発生率高)
*   `AFTERNOON` / `AFTER_SCHOOL`: **イベント・講義**
*   `NIGHT`: **ラストスパート** (疲労蓄積)
*   `LATE_NIGHT`: **危険領域** (高効率だが、SAN減少・睡眠負債増大)

### 2.3 状態異常とバフ (Status Effects)
*   **睡眠負債**: 深夜活動で蓄積。解消しないと回復行動の効果が激減する。
*   **カフェイン中毒**: 摂取量150mg超で発動。毎ターンHP/SANダメージ。
*   **狂気 (Madness)**: SAN<30で発動。学習効率UPだが、HP消費増。破滅的な集中力。

---

## 🏗 3. アーキテクチャ設計

Feature-Sliced Design (FSD) の影響を受けた、関心の分離を徹底した構成です。

### 3.1 ディレクトリ構造マップ
```
src/
├── components/       # UI層 (View)
│   ├── ui/           # 汎用部品 (Button, Panel...)
│   └── status/       # ステータス表示系
├── logic/            # ロジック層 (Model/Controller)
│   ├── handlers/     # アクション別処理 (study, rest...)
│   ├── reducer.ts    # 状態遷移の中核
│   └── effectProcessor.ts # 副作用適用の一元管理
├── data/             # データ層 (Data)
│   ├── events/       # イベント定義 (JSON-like TS)
│   │   ├── branching_details/ # 分割されたシナリオ定義
│   │   └── ...
│   └── items.ts      # アイテム定義
├── config/           # 設定層 (Config)
│   └── gameBalance.ts # 全バランス定数
└── types/            # 型定義 (Types)
```

### 3.2 Effect Processor Pattern
ゲーム内のあらゆる状態変化（アイテム使用、イベント結果、学習成果）は、統一された `GameEventEffect` オブジェクトとして表現し、単一の `applyEffect` 関数で処理します。
これにより、**「何が起きたか」のログ生成を自動化・統一化**しています。

**v2.5 Update**: `GameEventEffect` に `flags` プロパティを追加し、`hasPastPapers` などのフラグ操作も一元管理するように変更しました。

### 3.3 データ駆動設計
イベントやアイテムはTypeScriptファイルとして定義されていますが、構造はJSONに近く、ロジックから分離されています。これにより、将来的なDLC追加やMOD対応（外部JSON読み込み等）への拡張性を担保しています。

---

## 🛠 4. 拡張ロードマップ

### Phase 1: 基盤強化 (v2.x) - Current
- [x] Tauriによるデスクトップアプリ化
- [x] PWA対応（オフラインプレイ）
- [x] カフェイン・満腹度システムの刷新
- [x] 60点ラインの視覚的マーカー実装
- [x] イベントデータの大規模リファクタリング (FSD分割)
- [x] **総合演習バランス調整 (v2.6)**: 授業中不可、科目特性反映、深夜補正。

### Phase 2: 演出強化 (v3.0)
- [ ] Framer MotionによるリッチなUIアニメーション
- [ ] シェーダーを用いた背景エフェクト（雨、ノイズ）
- [ ] サウンドエンジンの強化（環境音のレイヤリング）

### Phase 3: コンテンツ拡張 (v4.0)
- [ ] マルチエンディング（就職、大学院、起業...）
- [ ] "After Story" DLC（研究室配属編）
- [ ] 実績システム (Achievements)

---

## 📝 5. バランス調整プロトコル

数値を変更する際は、以下のルールに従ってください。

1.  **ハードコード禁止**: 全て `config/gameBalance.ts` または `config/gameConstants.ts` に定義する。
2.  **ROI (投資対効果) の適正化**:
    *   高額アイテムは、その価格に見合う劇的な効果（時短、危機回避）を持たせること。
    *   「高いのに効果が薄い」アイテムは罠であり、プレイヤーの意欲を削ぐため徹底的に排除・修正する。
    *   目安: `価格 ÷ 100 ≒ スコア期待値`。リスクがある場合は価格を割引く。
3.  **テストプレイ**: 変更後は必ず `scripts/balance-report.ts` (概念的ツール) または手動プレイで「60点到達ターン数」を確認する。

### 5.1 総合演習 (Study All) の設計方針 (v2.6)
- **目的**: 汎用的な復習手段だが、特定の弱点克服には向かない。
- **仕様**:
    - **科目特性の反映**: 難易度係数により、伸びる科目と伸びない科目が分かれる。ランダム性もあり。
    - **時間帯制限**: 授業中（午前・午後）は実行不可。
    - **深夜補正**: 静寂ボーナスで効率UPするが、コストが激増するハイリスク行動。

---

> *"Code determines the rules, but Balance determines the fun."*

---

## 🧩 6. コード構成原則 (Line Count-Free Modularity)

行数による機械的な分割ガイドラインは撤廃し、以下の「質的指標」に基づいて継続的にモジュール境界を最適化する。

### 6.1 分割/再構成判断トリガー
- **認知的複雑度**: 単一関数/ロジックブロックの Cognitive Complexity が概ね 15 以上。
- **ドメイン語彙混在**: ファイル内に 3 種類以上の異なるドメイン語彙（例: 学習/休息/経済/イベント）が恒常的に共存。
- **変更チャーン (High Churn)**: Git 履歴で短期間に無関係な目的の変更が 3 回以上同一ファイルへ集中。
- **テスト容易性低下**: 部分的なテストが困難（依存初期化が煩雑 / モックが層を跨ぐ）。
- **パフォーマンス境界侵食**: 頻繁に呼ばれるホットパスが汎用ドメインモデルと同居し最適化が阻害される。

### 6.2 レビュー閾値 (非ハード制限)
行数は意図的に制限しない。ただし概ね **500 行超** は「凝集度再評価」のレビュー対象として扱い、分割メリット (テスト/変更局所性/認知負荷低減) と現在構造維持メリット (連続性/検索性/設定集約) を比較する。

### 6.3 推奨アプローチ
- 小さな関数抽出より **語彙境界 (Domain Lexicon Boundary)** を優先して塊を形成。
- Fixture / Factory / Pure Logic を分離し、副作用境界を明確化 (`logic/effectProcessor.ts` 等)。
- 複雑なアルゴリズムは計算的意図をコメントで “Why” のみ記述し、数式根拠は設計書へ。コード内に冗長な手続き説明を残さない。

### 6.4 保守診断チェックリスト
| 指標 | 兆候 | 推奨アクション |
| ---- | ---- | ---- |
| 認知的複雑度 | 15+ | 抽象化 or 分割 (Handler / Calculator 化) |
| 変更チャーン | 無関係コミット集中 | FSD レイヤ再編成 / 境界引き直し |
| テスト容易性 | モック階層化 | 副作用分離 / Pure 化 |
| パフォーマンス | ホットパス混在 | 専用モジュールへ抽出 / キャッシュ導入 |

### 6.5 意図の明示
分割が困難で構造維持を選択した場合は、冒頭コメントに:
`// WHY: Cohesion retained to keep X/Y invariants synchronized across Z transitions.` を記述し、再分割検討の未来参照点を提供する。

> *"We optimize for cognitive clarity, not arbitrary counts."*
